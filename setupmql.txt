#property strict
#include <Trade/Trade.mqh>
CTrade trade;

input string FileName = "signals.txt";   // file ch·ª©a t√≠n hi·ªáu t·ª´ TradingView
input double Lots = 0.1;                 // üëâ Lot t√πy ch·ªânh (b·∫°n ch·ªânh tr·ª±c ti·∫øp trong EA)

//=== H√†m x√≥a kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi ===
string Trim(string s)
{
   StringTrimLeft(s);
   StringTrimRight(s);
   return s;
}

//=== H√†m l·∫•y gi√° tr·ªã trong JSON theo key ===
string GetJsonValue(string json, string key)
{
   int p = StringFind(json, "\"" + key + "\"");
   if(p == -1) return "";
   int colon = StringFind(json, ":", p);
   if(colon == -1) return "";
   int comma = StringFind(json, ",", colon);
   if(comma == -1) comma = StringFind(json, "}", colon);
   if(comma == -1) return "";
   string val = StringSubstr(json, colon+1, comma - colon - 1);
   StringReplace(val, "\"", "");
   val = Trim(val);
   return val;
}

//=== H√†m x·ª≠ l√Ω t√≠n hi·ªáu JSON ===
void ProcessSignal(string json)
{
   Print("N·ªôi dung t√≠n hi·ªáu: ", json);

   string action = GetJsonValue(json, "ACTION");
   string symbol = GetJsonValue(json, "SYMBOL");  // l·∫•y symbol t·ª´ JSON
   double tp     = StringToDouble(GetJsonValue(json, "TP"));
   double sl     = StringToDouble(GetJsonValue(json, "SL"));

   // üëâ Check symbol tr√πng v·ªõi chart ƒëang ch·∫°y
   if(symbol != "" && symbol+"m" != _Symbol)
   {
      Print("‚ö†Ô∏è B·ªè qua t√≠n hi·ªáu v√¨ SYMBOL=", symbol, " kh√¥ng kh·ªõp v·ªõi chart: ", _Symbol);
      return;
   }

   if(action == "BUY")
   {
      Print("==> Nh·∫≠n t√≠n hi·ªáu BUY tr√™n ", _Symbol, " LOT=", Lots, " TP=", tp, " SL=", sl);
      trade.Buy(Lots, _Symbol, 0, sl, tp, "TV Buy");
   }
   else if(action == "SELL")
   {
      Print("==> Nh·∫≠n t√≠n hi·ªáu SELL tr√™n ", _Symbol, " LOT=", Lots, " TP=", tp, " SL=", sl);
      trade.Sell(Lots, _Symbol, 0, sl, tp, "TV Sell");
   }
}

//=== OnTick ƒë·ªçc file t√≠n hi·ªáu ===
void OnTick()
{
   int handle = FileOpen(FileName, FILE_READ|FILE_TXT|FILE_SHARE_READ|FILE_ANSI);
   if(handle != INVALID_HANDLE)
   {
      string line;
      while(!FileIsEnding(handle))
      {
         line = FileReadString(handle);
         if(line != "")
         {
            ProcessSignal(line);
         }
      }
      FileClose(handle);
      
      // X√≥a n·ªôi dung file sau khi x·ª≠ l√Ω ƒë·ªÉ tr√°nh nh·ªìi l·ªánh
      int clear = FileOpen(FileName, FILE_WRITE|FILE_TXT);
      if(clear != INVALID_HANDLE)
      {
         FileWrite(clear, "");
         FileClose(clear);
      }
   }
}