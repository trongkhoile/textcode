#property strict
#include <Trade/Trade.mqh>
#include <Trade/PositionInfo.mqh>
CPositionInfo m_position;
CTrade trade;

input string FileName = "signals.txt";   // File ch·ª©a t√≠n hi·ªáu
input double Lots     = 0.1;             // Lot m·∫∑c ƒë·ªãnh
input double TP       = 0;               // TP m·∫∑c ƒë·ªãnh (0 = kh√¥ng TP)
input double SL       = 0;               // SL m·∫∑c ƒë·ªãnh (0 = kh√¥ng SL)

//=== H√†m Trim x√≥a kho·∫£ng tr·∫Øng ===
string Trim(string s)
{
   StringTrimLeft(s);
   StringTrimRight(s);
   return s;
}
void WriteCheck(string action)
{
    int handle = FileOpen("check.txt", FILE_WRITE|FILE_TXT|FILE_ANSI);
    if(handle != INVALID_HANDLE)
    {
        FileWrite(handle, action);  // ghi BUY ho·∫∑c SELL
        FileClose(handle);
    }
    else
    {
        Print("‚ùå L·ªói m·ªü file check.txt ƒë·ªÉ ghi");
    }
}
string ReadCheck()
{
    string result = "";
    int handle = FileOpen("check.txt", FILE_READ|FILE_TXT|FILE_ANSI);
    if(handle != INVALID_HANDLE)
    {
        if(!FileIsEnding(handle))
            result = FileReadString(handle); // ƒë·ªçc 1 d√≤ng
        FileClose(handle);
    }
    else
    {
        Print("‚ùå L·ªói m·ªü file check.txt ƒë·ªÉ ƒë·ªçc");
    }
    return result;
}
void CloseAllOrders()
{
   int total = PositionsTotal();
   for(int i = total-1; i >= 0; i--)
   {
      if(m_position.SelectByIndex(i))
      {
         string sym   = m_position.Symbol();
         ulong  ticket= m_position.Ticket();
         double volume= m_position.Volume();

         if(sym == _Symbol)
         {
            Print("üîª ƒê√≥ng l·ªánh ticket=", ticket, " vol=", volume);

            // MT5 Hedging ‚Üí ƒë√≥ng t·ª´ng l·ªánh
            if(!trade.PositionClosePartial(ticket, volume))
            {
               Print("‚ùå L·ªói ƒë√≥ng ticket=", ticket,
                     " code=", GetLastError());
            }
         }
      }
   }
}


//=== H√†m x·ª≠ l√Ω text t√≠n hi·ªáu ===
void ProcessSignal(string text)
{
   Print("üì© Nh·∫≠n t√≠n hi·ªáu: ", text);
   text = Trim(text);

   string action = "";
   string symbol = "";

   // X√°c ƒë·ªãnh BUY/SELL
   if(StringFind(text, "BUY") != -1)  action = "BUY";
   if(StringFind(text, "SELL") != -1) action = "SELL";

   // L·∫•y symbol (v√≠ d·ª• BTCUSD)
   if(StringFind(text, "BTCUSD") != -1) symbol = "BTCUSD";
   if(StringFind(text, "EURUSD") != -1) symbol = "EURUSD";
   if(StringFind(text, "XAUUSD") != -1) symbol = "XAUUSD";
   // üëâ Th√™m c√°c c·∫∑p kh√°c n·∫øu b·∫°n mu·ªën
   Print(action);
   if(symbol == "" || action == "")
   {
      Print("‚ö†Ô∏è Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c symbol ho·∫∑c action trong text");
      return;
   }

   // Check c√≥ ƒë√∫ng chart kh√¥ng
   if(symbol != _Symbol)
   {
      Print("‚ö†Ô∏è B·ªè qua t√≠n hi·ªáu v√¨ symbol=", symbol, " kh√°c chart=", _Symbol);
      return;
   }

   // N·∫øu BUY
   if(action == "BUY")
   {
      long type = PositionGetInteger(POSITION_TYPE);
      Print(type);
      if(ReadCheck() == "SELL" && PositionSelect(_Symbol)){
         CloseAllOrders();
      }
      trade.Buy(Lots, _Symbol, 0, SL, TP, "TV BUY");
      WriteCheck("BUY");
   }
   // N·∫øu SELL
   else if(action == "SELL")
   {
      long type = PositionGetInteger(POSITION_TYPE);
      Print(type);
      if(ReadCheck()=="BUY" && PositionSelect(_Symbol)){
         CloseAllOrders();
      }
      trade.Sell(Lots, _Symbol, 0, SL, TP, "TV SELL");
      WriteCheck("SELL");
   }
}

//=== OnTick ƒë·ªçc file t√≠n hi·ªáu ===
void OnTick()
{
   int handle = FileOpen(FileName, FILE_READ|FILE_TXT|FILE_SHARE_READ|FILE_ANSI);
   if(handle != INVALID_HANDLE)
   {
      string line;
      while(!FileIsEnding(handle))
      {
         line = FileReadString(handle);
         if(line != "")
            ProcessSignal(line);
      }
      FileClose(handle);

      // X√≥a n·ªôi dung file sau khi x·ª≠ l√Ω
      int clear = FileOpen(FileName, FILE_WRITE|FILE_TXT);
      if(clear != INVALID_HANDLE)
      {
         FileWrite(clear, "");
         FileClose(clear);
      }
   }
}
