#include <Trade/Trade.mqh>

CTrade trade;

//=== C·∫•u h√¨nh c∆° b·∫£n ===//
input int Chaymotchieu = 0; // 0 = ch·ªâ BUY, 1 = ch·ªâ SELL, 2 = c·∫£ hai
input double Lots = 0.01;
input double TP_Pips = 80;
input double SL_Pips = 25;
input double BuyStart = 50;//kho·∫£ng rsi,stoch c·ªßa phe buy b·∫Øt ƒë·∫ßu
input double BuyEnd = 80;//kho·∫£ng rsi,stoch c·ªßa phe sell k·∫øt th√∫c
input double SellStart = 20;//kho·∫£ng rsi,stoch c·ªßa phe sell b·∫Øt ƒë·∫ßu
input double SellEnd = 50;//kho·∫£ng rsi,stoch c·ªßa phe sell k·∫øt th√∫c
input double ADX_Min = 20; //kho·∫£ng adx >=
input int FastEMA = 50;
input int SlowEMA = 100;
input int RSI_Period = 7;
input int K_Period = 7;      // Stoch %K period
input int D_Period = 3;      // Stoch %D period
input int Slowing = 3;       // Stoch slowing
input int ADX_Period = 14;       // ‚úÖ th√™m ADX
input ENUM_TIMEFRAMES TimeFrame = PERIOD_CURRENT;
input ulong MagicNumber = 123456;   // ‚úÖ th√™m MagicNumber ƒë·ªÉ qu·∫£n l√Ω l·ªánh

//=== Handle cho EMA / RSI / Stoch ===//
int fastEMA_handle;
int slowEMA_handle;
int rsi_handle;
int stoch_handle;
int adx_handle;  //
datetime lastBarTime = 0;

//=== Kh·ªüi t·∫°o EA ===//

int OnInit()
{
    trade.SetExpertMagicNumber(123456);

    fastEMA_handle = iMA(_Symbol, TimeFrame, FastEMA, 0, MODE_EMA, PRICE_CLOSE);
    slowEMA_handle = iMA(_Symbol, TimeFrame, SlowEMA, 0, MODE_EMA, PRICE_CLOSE);
    rsi_handle     = iRSI(_Symbol, TimeFrame, RSI_Period, PRICE_CLOSE);
    stoch_handle   = iStochastic(_Symbol, TimeFrame, K_Period, D_Period, Slowing, MODE_SMA, 0);
    adx_handle     = iADX(_Symbol, TimeFrame, ADX_Period);  // ‚úÖ t·∫°o handle ADX
    if(fastEMA_handle == INVALID_HANDLE || slowEMA_handle == INVALID_HANDLE || 
       rsi_handle == INVALID_HANDLE || stoch_handle == INVALID_HANDLE || adx_handle == INVALID_HANDLE)
    {
        Print("‚ùå L·ªói t·∫°o handle EMA / RSI / Stoch / ADX");
        return(INIT_FAILED);
    }

    Print("‚úÖ EA EMA Cross + RSI + Stoch + ADX ƒë√£ kh·ªüi ƒë·ªông th√†nh c√¥ng!");
    return(INIT_SUCCEEDED);
}

//=== ƒê√≥ng l·ªánh ng∆∞·ª£c chi·ªÅu ===//
void CloseAllPositions(int direction) // 1 = Buy, -1 = Sell
{
   for(int i = PositionsTotal() - 1; i >= 0; i--)
   {
      if(PositionGetSymbol(i) != _Symbol) continue;

      long type = PositionGetInteger(POSITION_TYPE);
      ulong ticket = PositionGetInteger(POSITION_TICKET);

      if((direction == 1 && type == POSITION_TYPE_SELL) || 
         (direction == -1 && type == POSITION_TYPE_BUY))
      {
         trade.PositionClose(_Symbol);
         Print("‚ö†Ô∏è ƒê√≥ng l·ªánh ng∆∞·ª£c chi·ªÅu #", ticket);
      }
   }
}

bool HasAnyMyOrder(ulong magic)
{
   for(int i = 0; i < PositionsTotal(); i++)
   {
      string pos_symbol = PositionGetSymbol(i);
      if(PositionSelect(pos_symbol))
      {
         long mg = PositionGetInteger(POSITION_MAGIC);
         if(mg == (long)magic)
            return true;
      }
   }
   return false;
}
//=== H√†m OnTick ===//
void OnTick()
{
    if(PositionSelect(_Symbol))
    {
       long type = PositionGetInteger(POSITION_TYPE);
       double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);
       double sl = PositionGetDouble(POSITION_SL);
       double currentPrice = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(_Symbol, SYMBOL_BID)
                                                         : SymbolInfoDouble(_Symbol, SYMBOL_ASK);
   
       double profitPips;
       double pipValue = (_Digits == 3 || _Digits == 5) ? 10 * _Point : _Point;
   
       if(type == POSITION_TYPE_BUY)
           profitPips = (currentPrice - openPrice) / pipValue;
       else
           profitPips = (openPrice - currentPrice) / pipValue;
   
       if(profitPips >= 25) // ƒë·∫°t 25 pip l·ª£i nhu·∫≠n
       {
           double newSL = openPrice; // d·ªãch SL v·ªÅ h√≤a v·ªën
           // ch·ªâ d·ªãch n·∫øu SL ch∆∞a v∆∞·ª£t openPrice
           if((type == POSITION_TYPE_BUY && sl < newSL) || (type == POSITION_TYPE_SELL && sl > newSL))
           {
               if(!trade.PositionModify(_Symbol, newSL, PositionGetDouble(POSITION_TP)))
                   Print("‚ùå D·ªùi SL v·ªÅ BE th·∫•t b·∫°i: ", _LastError);
               else
                   Print("‚úÖ D·ªùi SL v·ªÅ BE t·∫°i ", DoubleToString(newSL, _Digits));
           }
       }
    }
    datetime currentBarTime = iTime(_Symbol, TimeFrame, 0);
    if(currentBarTime == lastBarTime) return; // ch·ªâ ch·∫°y khi sang n·∫øn m·ªõi
    lastBarTime = currentBarTime;
    
    if(PositionSelect(_Symbol))
      return; // b·ªè qua v√¨ ƒë√£ c√≥ l·ªánh m·ªü
    // ‚úÖ Ki·ªÉm tra n·∫øu ƒë√£ c√≥ l·ªánh m·ªü th√¨ b·ªè qua tick n√†y
    double emaFast[2], emaSlow[2], rsi[2];
    double stochK[1], stochD[1], adx[1];

    CopyBuffer(fastEMA_handle, 0, 1, 2, emaFast);
    CopyBuffer(slowEMA_handle, 0, 1, 2, emaSlow);
    CopyBuffer(rsi_handle, 0, 1, 1, rsi);
    CopyBuffer(stoch_handle, 0, 1, 1, stochK);
    CopyBuffer(stoch_handle, 1, 1, 1, stochD);
    CopyBuffer(adx_handle, 0, 1, 1, adx);
    
    double prevFast = emaFast[0];
    double prevSlow = emaSlow[0];
    double prev2Fast = emaFast[1];
    double prev2Slow = emaSlow[1];
    double rsiPrev = rsi[0];
    double stochK_prev = stochK[0];
    double stochD_prev = stochD[0];
    double adxPrev = adx[0];
    
    double ask = SymbolInfoDouble(_Symbol, SYMBOL_ASK);
    double bid = SymbolInfoDouble(_Symbol, SYMBOL_BID);

    double sl, tp;
    double pipValue = (_Digits == 3 || _Digits == 5) ? 10 * _Point : _Point;   
    
    // === BUY n·∫øu EMA 50 c·∫Øt l√™n EMA 100 v√† ƒëi·ªÅu ki·ªán RSI/Stoch th·ªèa ===
    if(prev2Fast > prev2Slow && prevFast < prevSlow && (rsiPrev >= BuyStart && rsiPrev <= BuyEnd) && (stochK_prev >= BuyStart && stochK_prev <= BuyEnd) && adxPrev >= ADX_Min && (Chaymotchieu == 0 || Chaymotchieu == 2))
    {
        CloseAllPositions(1); 
        sl = NormalizeDouble(ask - SL_Pips*pipValue, _Digits);
        tp = NormalizeDouble(ask + TP_Pips*pipValue, _Digits);

        if(trade.Buy(Lots, _Symbol, 0, sl, tp))
            Print("üü¢ Buy t·∫°i m·ªü n·∫øn m·ªõi, gi√° ", ask, " SL=", sl, " TP=", tp);
        else
            Print("‚ùå Buy th·∫•t b·∫°i: ", _LastError);
    }

    // === SELL n·∫øu EMA 50 c·∫Øt xu·ªëng EMA 100 v√† ƒëi·ªÅu ki·ªán RSI/Stoch th·ªèa ===
    if(prev2Fast < prev2Slow && prevFast > prevSlow && (rsiPrev >= SellStart && rsiPrev <= SellEnd) && (stochK_prev >= SellStart && stochK_prev <= SellEnd) && adxPrev >= ADX_Min && (Chaymotchieu == 0 || Chaymotchieu == 2))
    {
        CloseAllPositions(-1); 
        sl = NormalizeDouble(bid + SL_Pips*pipValue, _Digits);
        tp = NormalizeDouble(bid - TP_Pips*pipValue, _Digits);

        if(trade.Sell(Lots, _Symbol, 0, sl, tp))
            Print("üî¥ Sell t·∫°i m·ªü n·∫øn m·ªõi, gi√° ", bid, " SL=", sl, " TP=", tp);
        else
            Print("‚ùå Sell th·∫•t b·∫°i: ", _LastError);
    }
}























